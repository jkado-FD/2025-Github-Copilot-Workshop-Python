# Pomodoro Webアプリ：段階的実装計画（Phase Plan）

この計画は、[architecture.md](architecture.md) の方針（クライアント主導タイマー、Flaskは配信＋設定/履歴API、`end_at` ベース復元、DI/Clock/reducerでテスト容易性）と、UIモックに沿って段階的に価値を積み上げるための実装順序です。

---

## Phase 0: 土台（動くHello UI）
**目的**: Flaskで1ページを配信し、JS/CSSが読み込まれる状態を作る。

**実装**
- `GET /` でモックに近い静的UI（レイアウトのみ）を表示
- `static/js/app.js` がロードされ、ボタン押下でコンソールログが出る

**受け入れ条件**
- ブラウザで画面が表示できる
- JSが動作していることが確認できる（クリックでログ等）

---

## Phase 1: タイマーMVP（クライアント完結）
**目的**: APIなしでPomodoroの最小機能を完成させる。

**実装**
- reducer（状態遷移）＋ `end_at` ベース残り時間計算
- UI操作（Start / Pause / Resume / Reset、モード切替）
- 0秒到達時の自動遷移（Focus→Break）

**テスト（最小）**
- reducerのユニットテスト（状態×アクション）
- 0秒遷移・二重遷移防止のテスト

**受け入れ条件**
- 画面上でPomodoroとして最低限使える（手動で動作確認可能）

---

## Phase 2: 復元（リロード/スリープ耐性）
**目的**: 実用性の核である「復元」を固める（後から入れると手戻りが増えやすい）。

**実装**
- LocalStorageに状態を保存（例：`mode` / `end_at` / `paused_remaining_ms` / `status`）
- 起動時に状態復元し、`end_at - now` で残り時間を再計算
- タブ非アクティブ復帰時もズレにくい更新（表示は再計算ベース）

**テスト（最小）**
- `now()` 注入で復元ロジックのユニットテスト

**受け入れ条件**
- リロードしてもタイマー状態が継続する
- PCスリープ後やタブ復帰後も破綻しにくい

---

## Phase 3: 設定（サーバ保存の導入）
**目的**: Focus/Break時間などをユーザー設定として保存し、UIへ反映する。

**実装**
- `GET/PUT /api/settings`（SQLite保存）
- 画面から設定変更→保存→反映
- 入力バリデーション（範囲、整数など）

**テスト（最小）**
- Flask `test_client()` で settings APIの正常系・異常系

**受け入れ条件**
- 再読み込みしても設定が保持される

---

## Phase 4: 履歴（セッション記録）
**目的**: セッション（Focus/Break）の完了/中断をサーバに記録できるようにする。

**実装**
- `POST /api/sessions`（`type`、`started_at`、`ended_at`、`completed` など）
- 0秒到達時に「1回だけ」送信（重複送信ガード）
- UIモックに履歴表示がある場合は、最低限の一覧表示を追加（なければ保存のみでも可）

**テスト（最小）**
- sessions API契約テスト
- フロント側は「送信が1回」のユニットテスト（APIクライアントをモック）

**受け入れ条件**
- Focus完了で履歴が1件増える（DBに保存される）

---

## Phase 5: 仕上げ（UX/安定性/リファクタ）
**目的**: UIモックの最終調整と品質強化を行う。

**実装**
- エラーハンドリング（API失敗時のUI表示、ローカル継続の方針を最小で確定）
- UI微調整（余白/配置、最低限のアクセシビリティ）
- バックエンドのレイヤ分離を明確化（Route/Service/Repo/Clockの責務を整理）

**テスト（必要に応じて追加）**
- サービス層ユニットテスト（Repo/Clock差し替え）
- 主要バグの回帰テストを追加

**受け入れ条件**
- UIモックに対して必要十分な一致
- 主要な例外系でアプリが破綻しない

---

## 粒度の目安（運用ルール）
- 1フェーズ=「デモ可能な価値」が出る単位（30分〜2時間目安）
- 復元（Phase 2）は早めに確定（後から入れると状態が複雑化して手戻りが増えやすい）
